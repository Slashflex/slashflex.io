{% extends "base.html.twig" %}

{% block titre %}
	{{ article.title }}
{% endblock %}

{% block body %}
	<!-- Logo -->
	{% include "partials/_top_buttons.html.twig" %}

	<!-- Fullscreen Navigation -->
	{% include "partials/_fullscreen_nav.html.twig" %}

	{% for message in app.flashes('success') %}
		<div class="flash-notice alert-success">
			{{ message }}
		</div>
	{% endfor %}

	<header class="header__blog" style="background-image: url('/uploads/images/{{ article.imageName }}');">
		{# <div class="container h-100">
			<div class="row h-100 align-items-center">
				<div class="col-12 text-center article-intro">
					<h1>{{ article.title|capitalize }}</h1>
					<p>{{ article.introduction|capitalize }}</p>
				</div>
			</div>
		</div> #}
	</header>

	<div class="container">
		<div class="row mt-5 mb-5 moving">
			{{ article.content|raw }}
		</div>
		<hr class="separator">
		<div class="row">
			<h4 class="comments-counter">
				{% if not app.user %}
					You need to be logged in to post or reply to a comment
				{% else %}
					{% if article.comments|length >= 1 %}
						<i class="fas fa-comments"></i> Comment section
					{% else %}
						<!-- No comment -->
						No comment yet! Post the first oneðŸ˜€
					{% endif %}
				{% endif %}
			</h4>

			<div class="comments user-info-comments col-lg-12 moving">
                <ul class="commentaire"></ul>
            </div>
        </div>

		{% if app.user %}
			{{ form_start(form) }}
				<div class="form__group">
					{{ form_widget(form.content, {'attr': { 'class': 'moving form__input comment-block d-block', 'placeholder': 'Add comment...', 'cols': '10', 'rows': '5' }}) }}
					<label for="content" class="form__label">Comment</label>
					<span class="textRequired form__label"></span>
				</div>

				<div class="form-group">
					<button type="button" class="button__login mx-auto d-block postComment">Publish</button>
				</div>
			{{ form_end(form) }}
		{% endif %}
    </div>
	<!-- Footer -->
	{% include "partials/_footer.html.twig" %}
{% endblock %}

{% block javascripts %}
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
   	<script language="javascript">
        let commentaire = '';
		let author = "<br><span class='article__author'>Published by {{article.users}} {{article.createdAt|ago}}</span>";

		$('.language__title').append(author)

		{% for comment in comments %}
            {% set idParent = "-1" %}
            
            {% if comment.parent is not null %}
                {% set idParent = comment.parent.id %}
            {% endif %}
        
            commentaire = `
                <li>
                    <div class="comment-wrap">
                        <div class="photo">
                            <div class="avatar" {% if comment.users.avatar != 'avatar.png' %} style="background-image: url(/uploads/avatars/{{ comment.users.slug }}/{{ comment.users.avatar }})" {% else %} style="background-image: url(/uploads/avatars/{{ comment.users.avatar }})" {% endif %}></div>
						</div>
                        <div class="comment-block">
                            <div class="comment-tile">{{ comment.users.__toString }}</div>
                            <p class="comment-text">{{ comment.content|capitalize }}</p>
                            <div class="bottom-comment">
                                <div class="comment-date">
                                    about {{ comment.createdAt|ago }}
                                </div>
                                <span class="d-flex justify-content-end float-right">
                                    {% if app.user != comment.users and app.user %}
                                        <button id="loadComments-{{ comment.id }}" class="button__login d-block" style="background-color: #ffbe41; color: black;">Reply</button>  
                                    {% endif %}
                                
                                    {% if comment.users is same as(app.user) %}
                                        <a href="{{ path('delete_comment', {'id': comment.id }) }}" class="button__login--del"><i class="fas fa-trash-alt"></i></a>
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Reply to Comment with given ID -->
                    <form action="" style="display: none" id="reply-comment-{{ comment.id }}">
                        <textarea type="text" name="comment[content]" id="commentID-{{ comment.id }}" style="color: white; width: 93%; float: right;" class="form__input d-block comment-block" ></textarea>
                        <label for="message" class="form__label">Message</label>

                        <div class="form-group pt-2 pb-3">
                            <button type="button" id="postComment-{{ comment.id }}" class="button__login mx-auto d-block">Reply</button>
                        </div>
                    </form>
                    <ul class="reply-{{comment.id}}" style="width: 98%; float: right"></ul>
                </li>
            `;

			// Renders all comments if null
            if ("{{idParent}}" == "-1") {
				$('.commentaire').append(commentaire);
            } else {
				// Renders all comments and them childrens (replies to given comments)
                $(".reply-{{idParent}}").append(commentaire);
            }

			{% if app.user %}
				$('#loadComments-{{ comment.id }}').on('click', () => {
					$('#reply-comment-{{ comment.id }}').toggle();
					$('#commentID-{{ comment.id }}').focus();
				});

				$('#postComment-{{comment.id}}').on('click', () => {
					if ($("#commentID-{{comment.id}}").val() != '') {
						axios.post('/api/comments', {
							content: $('#commentID-{{comment.id}}').val().replace(/</g, "&lt;").replace(/>/g, "&gt;"),
							users: "/api/users/{{app.user.id}}",
							article: "/api/articles/{{article.id}}",
							parent: "/api/comments/{{comment.id}}"
						})
						.then(res => {
							let userData = res.data.users;
							let idComment = res.data.id;
							let first = userData.firstname.charAt(0).toLowerCase() + userData.firstname.slice(1);
							let last = userData.lastname.charAt(0).toLowerCase() + userData.lastname.slice(1);
							let name = `${userData.firstname} ${userData.lastname}`;
							let content = res.data.content.charAt(0).toUpperCase() + res.data.content.slice(1);

							let postComment = `
								<li>
									<div class="comment-wrap">
										<div class="photo">
											<div class="avatar" {% if comment.users.avatar != 'avatar.png' %} style="background-image: url(/uploads/avatars/${userData.slug}/${res.data.users.avatar})" {% else %} style="background-image: url(/uploads/avatars/${res.data.users.avatar})" {% endif %}></div>
										</div>
										<div class="comment-block">
											<div class="comment-tile">${name}</div>
											<p class="comment-text">${content}</p>
											<div class="bottom-comment">
												<div class="comment-date">
													about now
												</div>
												<span class="d-flex justify-content-end float-right">
													<a href="/comment/${idComment}/delete" class="button__login--del"><i class="fas fa-trash-alt"></i></a>
												</span>
											</div>
										</div>
									</div>

									<!-- Reply to Comment with given ID -->
									<form action="" style="display: none" id="reply-comment-${idComment}">
										<textarea type="text" name="comment[content]" id="commentID-${idComment}" style="color: white; width: 93%; float: right;" class="form__input d-block comment-block" ></textarea>
										<label for="message" class="form__label">Message</label>

										<div class="form-group pt-2 pb-3">
											<button type="button" id="postComment-${idComment}" class="button__login mx-auto d-block">Reply</button>
										</div>
									</form>
									<ul class="reply-${idComment}" style="width: 98%; float: right"></ul>
								</li>
							`;
							// Empty textarea
							$("#commentID-{{comment.id}}").val('');
							$('.reply-{{comment.id}}').append(postComment);
							$('#reply-comment-{{comment.id}}').hide();
						})
					}
				});
			{% endif %}
        {% endfor %}

		{% if app.user %}
			// Update Comment counter
			let text = "";
	
			// Update comment Counter by retrieving all comments
			axios.get('/api/comments').then(result => {
				$('.toggle__first-one').replaceWith(`
					<p class="text-center singular">No comment yet! Publish the first one</p>
				`);				
			});

			$('.postComment').on('click', () => {
        		let commentCount = document.querySelector('.comment__count');
				// Prevents from submitting an empty field
				if ($("#comment_content").val() != '') {
					// Post Request to custom API
					axios.post('/api/comments', {
						content: $("#comment_content").val().replace(/</g, "&lt;").replace(/>/g, "&gt;"),
						users: "/api/users/{{app.user.id}}",
						article: "/api/articles/{{article.id}}"
					})
					.then(res => {
						// Retrieves data as a response from the api call
						let userData = res.data.users;
						let idComment = res.data.id;
						let first = userData.firstname.charAt(0).toLowerCase() + userData.firstname.slice(1);
						let last = userData.lastname.charAt(0).toLowerCase() + userData.lastname.slice(1);
						let name = `${userData.firstname} ${userData.lastname}`;
						let content = res.data.content.charAt(0).toUpperCase() + res.data.content.slice(1);
						
						// Converts JS variables to use them inside Twig conditions
						{% set user = "userData" %}

						let postComment = `
							<li>
								<div class="comment-wrap">
									<div class="photo">
										<div class="avatar" style="background-image: url(/uploads/avatars/${userData.slug}/${res.data.users.avatar})"></div>
									</div>
									<div class="comment-block">
										<div class="comment-tile">${name}</div>
										<p class="comment-text">${content}</p>
										<div class="bottom-comment">
											<div class="comment-date">
												about now
											</div>
											<span class="d-flex justify-content-end float-right">
												<a href="/comment/${idComment}/delete" class="button__login--del"><i class="fas fa-trash-alt"></i></a>
											</span>
										</div>
									</div>
								</div>

								<!-- Reply to Comment with given ID -->
								<form action="" style="display: none" id="reply-comment-${idComment}">
									<textarea type="text" name="comment[content]" id="commentID-${idComment}" style="color: white; width: 93%; float: right;" class="form__input d-block comment-block" ></textarea>
									<label for="message" class="form__label">Message</label>

									<div class="form-group pt-2 pb-3">
										<button type="button" id="postComment-${idComment}" class="button__login mx-auto d-block">Reply</button>
									</div>
								</form>
								<ul class="reply-${idComment}" style="width: 98%; float: right"></ul>
							</li>
						`;
						
						// Empty textarea
						$("#comment_content").val('');
						$('.commentaire').append(postComment);
					});
				} else {
					$('.textRequired').text('This field is required')
					
					$("#comment_content").on('keypress', (e) => {
						$('.textRequired').css('display', 'none')
					});
				}
			});
		{% endif %}
    </script>
{% endblock %}